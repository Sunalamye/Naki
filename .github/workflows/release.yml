name: Build and Release

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-14

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable

    - name: Resolve Dependencies
      run: |
        xcodebuild -project Naki.xcodeproj \
          -scheme Naki \
          -resolvePackageDependencies

    - name: Build App
      run: |
        xcodebuild -project Naki.xcodeproj \
          -scheme Naki \
          -configuration Release \
          -archivePath build/Naki.xcarchive \
          archive \
          CODE_SIGN_IDENTITY="-" \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO

    - name: Export App
      run: |
        mkdir -p build/export
        cp -R build/Naki.xcarchive/Products/Applications/Naki.app build/export/

    - name: Create DMG
      run: |
        hdiutil create -volname "Naki" \
          -srcfolder build/export \
          -ov -format UDZO \
          build/Naki.dmg

    - name: Create ZIP
      run: |
        cd build/export
        zip -r ../Naki.zip Naki.app

    - name: Get version
      id: version
      run: |
        if [[ "${{ github.ref }}" == refs/tags/* ]]; then
          echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
        else
          echo "version=dev-$(date +%Y%m%d-%H%M%S)" >> $GITHUB_OUTPUT
        fi

    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: Naki-${{ steps.version.outputs.version }}
        path: |
          build/Naki.dmg
          build/Naki.zip

    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v2
      with:
        files: |
          build/Naki.dmg
          build/Naki.zip
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
